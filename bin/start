#!/usr/bin/env bash

# Production startup script for Search Analytics
echo "ğŸš€ Starting Search Analytics application..."

# Check if we're in production
if [ "$RAILS_ENV" = "production" ]; then
  echo "ğŸ“¦ Production environment detected"
  
  # Check if database is available
  echo "ğŸ—„ï¸  Checking database connection..."
  bundle exec rails db:version > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "âœ… Database connection successful"
  else
    echo "âŒ Database connection failed"
    exit 1
  fi
  
  # Check if Redis is available (optional)
  if [ -n "$REDIS_URL" ]; then
    echo "ğŸ”´ Checking Redis connection..."
    bundle exec rails runner "Redis.new(url: ENV['REDIS_URL']).ping" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      echo "âœ… Redis connection successful"
    else
      echo "âš ï¸  Redis connection failed, continuing without Redis"
    fi
  else
    echo "âš ï¸  REDIS_URL not set, continuing without Redis"
  fi
  
  # Run migrations
  echo "ğŸ”„ Running database migrations..."
  bundle exec rails db:migrate
  
  # Seed data if needed
  if [ "$SEED_DATA" = "true" ]; then
    echo "ğŸŒ± Seeding database..."
    bundle exec rails db:seed
  fi
  
  # Precompile assets
  echo "ğŸ¨ Precompiling assets..."
  bundle exec rails assets:precompile
  
  echo "âœ… Application ready to start"
else
  echo "ğŸ”§ Development environment detected"
fi

# Start the application
echo "ğŸš€ Starting Puma server..."
exec bundle exec puma -C config/puma.rb
