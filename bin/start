#!/usr/bin/env bash

# Production startup script for Search Analytics
echo "🚀 Starting Search Analytics application..."

# Check if we're in production
if [ "$RAILS_ENV" = "production" ]; then
  echo "📦 Production environment detected"
  
  # Check if database is available
  echo "🗄️  Checking database connection..."
  bundle exec rails db:version > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "✅ Database connection successful"
  else
    echo "❌ Database connection failed"
    exit 1
  fi
  
  # Check if Redis is available (optional)
  if [ -n "$REDIS_URL" ]; then
    echo "🔴 Checking Redis connection..."
    bundle exec rails runner "Redis.new(url: ENV['REDIS_URL']).ping" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      echo "✅ Redis connection successful"
    else
      echo "⚠️  Redis connection failed, continuing without Redis"
    fi
  else
    echo "⚠️  REDIS_URL not set, continuing without Redis"
  fi
  
  # Run migrations
  echo "🔄 Running database migrations..."
  bundle exec rails db:migrate
  
  # Seed data if needed
  if [ "$SEED_DATA" = "true" ]; then
    echo "🌱 Seeding database..."
    bundle exec rails db:seed
  fi
  
  # Precompile assets
  echo "🎨 Precompiling assets..."
  bundle exec rails assets:precompile
  
  echo "✅ Application ready to start"
else
  echo "🔧 Development environment detected"
fi

# Start the application
echo "🚀 Starting Puma server..."
exec bundle exec puma -C config/puma.rb
