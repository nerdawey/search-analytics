#!/usr/bin/env bash

# Production startup script for Search Analytics
echo "ğŸš€ Starting Search Analytics application..."

# Check if we're in production
if [ "$RAILS_ENV" = "production" ]; then
  echo "ğŸ“¦ Production environment detected"
  
  # Quick database connection check
  echo "ğŸ—„ï¸  Checking database connection..."
  timeout 10 bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "âœ… Database connection successful"
  else
    echo "âŒ Database connection failed"
    exit 1
  fi
  
  # Skip Redis check for faster startup (optional service)
  if [ -n "$REDIS_URL" ]; then
    echo "ğŸ”´ Redis URL configured (will check during runtime)"
  else
    echo "âš ï¸  REDIS_URL not set, continuing without Redis"
  fi
  
  # Run migrations
  echo "ğŸ”„ Running database migrations..."
  bundle exec rails db:migrate
  
  # Seed data if needed
  if [ "$SEED_DATA" = "true" ]; then
    echo "ğŸŒ± Seeding database..."
    bundle exec rails db:seed
  fi
  
  # Precompile assets
  echo "ğŸ¨ Precompiling assets..."
  bundle exec rails assets:precompile
  
  echo "âœ… Application ready to start"
else
  echo "ğŸ”§ Development environment detected"
fi

# Start the application
echo "ğŸš€ Starting Puma server..."
exec bundle exec puma -C config/puma.rb
